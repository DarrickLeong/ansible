---
- name: Migration AAP24RPM to AAP24OCP
  hosts: all
  #connection: local
  gather_facts: true

  vars:
    pg_password: Admin123!
    pg_user: awx
    backup_path: /home/darrick/ansible/migration/backup
  
  tasks:
  # Gather facts of all instances Controller/Automation Hub/PostgreSQL/Execution Nodes
  - name: Gather facts of all instances
    debug:
      var: ansible_facts

  - name: Verify PostgreSQL version
    ansible.builtin.command: "psql -U {{ pg_user }} -c 'SELECT version();'"
    environment:
      PGPASSWORD: "{{ pg_password }}"
    register: postgresql_version
    when: "'database' in group_names"

# Display PostgreSQL version, PostgreSQL version should be at least 15
  - name: Display PostgreSQL version 
    debug:
      msg: "{{ postgresql_version.stdout }}"
    when: "'database' in group_names"

  - name: Create a complete backup of the source environment
    ansible.builtin.command: "./setup.sh -e 'backup_dest={{ backup_path }}' -b"
    when: "'localhost' in group_names"